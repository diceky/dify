# Dify on Render â€” Web, API, Worker + Postgres
# You will manually fill:
# - GOOGLE_API_KEY (Gemini)
# - SECRET_KEY (copy from web into api & worker)
# - REDIS_URL (Upstash or self-hosted)
# - The five URL envs with your live Render URLs

services:
  - type: web
    name: dify-web
    runtime: docker
    image:
      url: langgenius/dify-web:latest
    plan: starter
    envVars:
      # ===== Required URLs (fill after deploy) =====
      - key: CONSOLE_WEB_URL
        sync: false
      - key: APP_WEB_URL
        sync: false
      - key: CONSOLE_API_URL
        sync: false
      - key: SERVICE_API_URL
        sync: false
      - key: APP_API_URL
        sync: false
      - key: FILES_URL
        sync: false
      # =============================================

      # Core secret (generated here; copy into api & worker)
      - key: SECRET_KEY
        generateValue: true

      # Backing services
      - key: DATABASE_URL
        fromDatabase: { name: dify-postgres, property: connectionString }
      - key: REDIS_URL
        sync: false

      # Gemini as default
      - key: DEFAULT_MODEL_PROVIDER
        value: google
      - key: GOOGLE_API_KEY
        sync: false
      - key: GOOGLE_MODEL
        value: gemini-1.5-flash

      # Optional: leave OpenAI blank
      - key: OPENAI_API_KEY
        sync: false

      # Storage choice (uncomment one block across ALL three services)
      # Local:
      # - key: STORAGE_TYPE
      #   value: local
      # S3:
      # - key: STORAGE_TYPE
      #   value: s3
      # - key: S3_ENDPOINT
      #   value: https://s3.ap-southeast-2.amazonaws.com
      # - key: S3_REGION
      #   value: ap-southeast-2
      # - key: S3_BUCKET
      #   value: dify-files
      # - key: S3_ACCESS_KEY
      #   sync: false
      # - key: S3_SECRET_KEY
      #   sync: false

  - type: web
    name: dify-api
    runtime: docker
    image:
      url: langgenius/dify-api:latest
    plan: starter
    envVars:
      # ===== Same URL keys; fill after deploy =====
      - key: SERVICE_API_URL
        sync: false
      - key: CONSOLE_API_URL
        sync: false
      - key: APP_API_URL
        sync: false
      - key: FILES_URL
        sync: false
      - key: CONSOLE_WEB_URL
        sync: false
      - key: APP_WEB_URL
        sync: false
      # ============================================

      - key: SECRET_KEY
        sync: false
      - key: DATABASE_URL
        fromDatabase: { name: dify-postgres, property: connectionString }
      - key: REDIS_URL
        sync: false

      # Gemini defaults
      - key: DEFAULT_MODEL_PROVIDER
        value: google
      - key: GOOGLE_API_KEY
        sync: false
      - key: GOOGLE_MODEL
        value: gemini-1.5-flash

      - key: OPENAI_API_KEY
        sync: false

    # If using LOCAL storage, mount disk at the SAME path as worker:
    # disk:
    #   name: dify-storage
    #   mountPath: /app/api/storage
    #   sizeGB: 5

  - type: worker
    name: dify-worker
    runtime: docker
    image:
      url: langgenius/dify-worker:latest
    plan: starter
    envVars:
      - key: SECRET_KEY
        sync: false
      - key: DATABASE_URL
        fromDatabase: { name: dify-postgres, property: connectionString }
      - key: REDIS_URL
        sync: false

      # Gemini defaults
      - key: DEFAULT_MODEL_PROVIDER
        value: google
      - key: GOOGLE_API_KEY
        sync: false
      - key: GOOGLE_MODEL
        value: gemini-1.5-flash

      - key: OPENAI_API_KEY
        sync: false

    # If using LOCAL storage, mount disk (path must match API):
    # disk:
    #   name: dify-storage
    #   mountPath: /app/api/storage
    #   sizeGB: 5

databases:
  - name: dify-postgres
    plan: starter
